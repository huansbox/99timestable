<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªéŸ³è¼¸å…¥æ¸¬è©¦ v2 - æ”¹è‰¯ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        h1 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .status.supported {
            background: #d4edda;
            color: #155724;
        }

        .status.unsupported {
            background: #f8d7da;
            color: #721c24;
        }

        .question-area {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .question {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .answer-area {
            font-size: 20px;
            color: #666;
            min-height: 30px;
        }

        .mic-button {
            width: 100px;
            height: 100px;
            border: none;
            border-radius: 50%;
            background: #667eea;
            color: white;
            font-size: 40px;
            cursor: pointer;
            margin: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }

        .mic-button:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }

        .mic-button.listening {
            background: #e53e3e;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(229, 62, 62, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(229, 62, 62, 0);
            }
        }

        .instructions {
            color: #666;
            margin-bottom: 20px;
        }

        .transcript-area {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .transcript-label {
            font-weight: bold;
            color: #856404;
            margin-bottom: 5px;
        }

        .transcript-text {
            color: #333;
            font-size: 16px;
        }

        .result-area {
            margin: 20px 0;
            font-size: 18px;
        }

        .result-correct {
            color: #28a745;
            font-weight: bold;
        }

        .result-incorrect {
            color: #dc3545;
            font-weight: bold;
        }

        .next-button {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 20px;
            display: none;
        }

        .next-button:hover {
            background: #38a169;
        }

        .debug-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ èªéŸ³è¼¸å…¥æ¸¬è©¦ v2</h1>

        <div id="status" class="status">
            æª¢æ¸¬ç€è¦½å™¨æ”¯æ´ç‹€æ…‹...
        </div>

        <div class="question-area">
            <div class="question" id="question">
                é»æ“Šéº¥å…‹é¢¨é–‹å§‹æ¸¬è©¦
            </div>
            <div class="answer-area" id="answer">
                ç­”æ¡ˆå°‡é¡¯ç¤ºåœ¨é€™è£¡
            </div>
        </div>

        <div class="instructions">
            é»æ“Šéº¥å…‹é¢¨æŒ‰éˆ•ï¼Œèªªå‡ºç­”æ¡ˆ
        </div>

        <button id="mic-button" class="mic-button">
            ğŸ¤
        </button>

        <div class="result-area" id="result">
            ç­‰å¾…æ¸¬è©¦...
        </div>

        <button id="next-button" class="next-button">
            ä¸‹ä¸€é¡Œ
        </button>

        <div id="transcript-area" class="transcript-area">
            <div class="transcript-label">èªéŸ³è­˜åˆ¥çµæœï¼š</div>
            <div class="transcript-text" id="transcript-text">-</div>
        </div>

        <div id="error-message" class="error-message">
            éŒ¯èª¤è¨Šæ¯
        </div>

        <div class="stats">
            <div>æ¸¬è©¦é€²åº¦ï¼š<span id="progress">0/10</span></div>
            <div>æˆåŠŸç‡ï¼š<span id="success-rate">0%</span></div>
        </div>

        <div class="debug-area">
            <strong>é™¤éŒ¯è³‡è¨Šï¼š</strong><br>
            <div id="debug-log">ç­‰å¾…é–‹å§‹æ¸¬è©¦...</div>
        </div>
    </div>

    <script>
        class VoiceTestV2 {
            constructor() {
                this.recognition = null;
                this.isSupported = false;
                this.isListening = false;

                this.questions = [
                    { num1: 2, num2: 3, answer: 6 },
                    { num1: 4, num2: 5, answer: 20 },
                    { num1: 3, num2: 8, answer: 24 },
                    { num1: 6, num2: 7, answer: 42 },
                    { num1: 9, num2: 4, answer: 36 },
                    { num1: 5, num2: 6, answer: 30 },
                    { num1: 7, num2: 8, answer: 56 },
                    { num1: 2, num2: 9, answer: 18 },
                    { num1: 8, num2: 3, answer: 24 },
                    { num1: 9, num2: 9, answer: 81 }
                ];

                this.currentQuestion = 0;
                this.results = [];
                this.debugMessages = [];

                this.init();
            }

            init() {
                this.checkSupport();
                this.setupEventListeners();
                this.loadQuestion();
            }

            checkSupport() {
                const statusEl = document.getElementById('status');

                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    this.isSupported = true;
                    statusEl.textContent = 'âœ… ç€è¦½å™¨æ”¯æ´èªéŸ³è­˜åˆ¥ - å¯ä»¥é–‹å§‹æ¸¬è©¦';
                    statusEl.className = 'status supported';
                    this.setupSpeechRecognition();
                } else {
                    this.isSupported = false;
                    statusEl.textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è­˜åˆ¥ - è«‹ä½¿ç”¨ Chrome æˆ– Edge';
                    statusEl.className = 'status unsupported';
                    document.getElementById('mic-button').disabled = true;
                }
            }

            setupSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();

                this.recognition.lang = 'zh-TW';
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.maxAlternatives = 3;

                this.recognition.onstart = () => {
                    this.log('âœ… èªéŸ³è­˜åˆ¥é–‹å§‹');
                    this.isListening = true;
                    this.updateMicButton();
                    this.startTime = Date.now();
                };

                this.recognition.onresult = (event) => {
                    this.log(`ğŸ“ æ”¶åˆ°è­˜åˆ¥çµæœï¼Œå…± ${event.results.length} å€‹çµæœ`);

                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = 0; i < event.results.length; i++) {
                        const result = event.results[i];
                        const transcript = result[0].transcript;

                        this.log(`   çµæœ ${i}: "${transcript}" (æœ€çµ‚: ${result.isFinal})`);

                        if (result.isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    // é¡¯ç¤ºä¸­é–“çµæœ
                    if (interimTranscript) {
                        document.getElementById('transcript-text').textContent = `(è­˜åˆ¥ä¸­) ${interimTranscript}`;
                        document.getElementById('transcript-area').style.display = 'block';
                    }

                    // è™•ç†æœ€çµ‚çµæœ - ç«‹å³è™•ç†ï¼Œä¸å»¶é²
                    if (finalTranscript) {
                        this.log(`ğŸ¯ æœ€çµ‚çµæœ: "${finalTranscript}"`);
                        // ç«‹å³è™•ç†çµæœï¼Œæå‡éŸ¿æ‡‰é€Ÿåº¦
                        setTimeout(() => {
                            this.processVoiceInput(finalTranscript);
                        }, 100); // æ¥µçŸ­å»¶é²ç¢ºä¿UIæ›´æ–°
                    }
                };

                this.recognition.onerror = (event) => {
                    this.log(`âŒ èªéŸ³è­˜åˆ¥éŒ¯èª¤: ${event.error}`);
                    this.showError(`èªéŸ³è­˜åˆ¥éŒ¯èª¤: ${event.error}`);
                    this.isListening = false;
                    this.updateMicButton();
                };

                this.recognition.onend = () => {
                    this.log('â¹ï¸ èªéŸ³è­˜åˆ¥çµæŸ');
                    this.isListening = false;
                    this.updateMicButton();
                };
            }

            setupEventListeners() {
                const micButton = document.getElementById('mic-button');
                const nextButton = document.getElementById('next-button');

                micButton.addEventListener('click', () => {
                    if (!this.isSupported) return;

                    if (this.isListening) {
                        this.stopListening();
                    } else {
                        this.startListening();
                    }
                });

                nextButton.addEventListener('click', () => {
                    this.nextQuestion();
                });
            }

            startListening() {
                if (!this.recognition || this.isListening) return;

                try {
                    this.log('ğŸ¤ å•Ÿå‹•èªéŸ³è­˜åˆ¥...');
                    this.recognition.start();
                    this.hideError();
                    document.getElementById('transcript-area').style.display = 'none';
                } catch (error) {
                    this.log(`âŒ å•Ÿå‹•å¤±æ•—: ${error.message}`);
                    this.showError(`å•Ÿå‹•èªéŸ³è­˜åˆ¥å¤±æ•—: ${error.message}`);
                }
            }

            stopListening() {
                if (this.recognition && this.isListening) {
                    this.log('â¹ï¸ æ‰‹å‹•åœæ­¢èªéŸ³è­˜åˆ¥');
                    this.recognition.stop();
                }
            }

            updateMicButton() {
                const button = document.getElementById('mic-button');
                if (this.isListening) {
                    button.textContent = 'ğŸ”´';
                    button.classList.add('listening');
                } else {
                    button.textContent = 'ğŸ¤';
                    button.classList.remove('listening');
                }
            }

            processVoiceInput(transcript) {
                this.log(`ğŸ”„ è™•ç†èªéŸ³è¼¸å…¥: "${transcript}"`);

                // é¡¯ç¤ºè­˜åˆ¥çµæœ
                document.getElementById('transcript-text').textContent = transcript;
                document.getElementById('transcript-area').style.display = 'block';

                // è½‰æ›ç‚ºæ•¸å­—
                const number = this.convertToNumber(transcript.trim());
                this.log(`ğŸ”¢ è½‰æ›çµæœ: ${number}`);

                if (number !== null) {
                    this.checkAnswer(number, transcript);
                } else {
                    document.getElementById('answer').textContent = 'ç„¡æ³•è­˜åˆ¥ç‚ºæ•¸å­—';
                    document.getElementById('result').innerHTML = '<span class="result-incorrect">âŒ ç„¡æ³•è­˜åˆ¥ç‚ºæ•¸å­—ï¼Œè«‹é‡è©¦</span>';
                }
            }

            convertToNumber(text) {
                this.log(`ğŸ”¤ è½‰æ›æ–‡å­—: "${text}"`);

                // ç§»é™¤ç©ºç™½å’Œæ¨™é»ç¬¦è™Ÿ
                text = text.replace(/[ï¼Œã€‚ï¼ï¼Ÿ\s]/g, '');

                // ç›´æ¥æ˜¯é˜¿æ‹‰ä¼¯æ•¸å­—
                if (/^\d+$/.test(text)) {
                    const num = parseInt(text);
                    return num >= 0 && num <= 99 ? num : null;
                }

                // ä¸­æ–‡æ•¸å­—å°ç…§è¡¨
                const chineseDigits = {
                    'é›¶': 0, 'ã€‡': 0,
                    'ä¸€': 1, 'å£¹': 1,
                    'äºŒ': 2, 'è²³': 2, 'å…©': 2,
                    'ä¸‰': 3, 'åƒ': 3,
                    'å››': 4, 'è‚†': 4,
                    'äº”': 5, 'ä¼': 5,
                    'å…­': 6, 'é™¸': 6,
                    'ä¸ƒ': 7, 'æŸ’': 7,
                    'å…«': 8, 'æŒ': 8,
                    'ä¹': 9, 'ç–': 9
                };

                // è™•ç†ç‰¹æ®Šæƒ…æ³
                if (text === 'å') return 10;

                // è™•ç† XåY æ ¼å¼ï¼ˆå¦‚ï¼šäºŒåå››ï¼‰
                const tenMatch = text.match(/^([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?)å([é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?)$/);
                if (tenMatch) {
                    const tens = tenMatch[1] ? chineseDigits[tenMatch[1]] : 1;
                    const ones = tenMatch[2] ? chineseDigits[tenMatch[2]] : 0;
                    return tens * 10 + ones;
                }

                // æ–°å¢ï¼šè™•ç†é€£çºŒæ•¸å­—ï¼ˆå¦‚ï¼šå››äºŒ â†’ 42ã€ä¸‰å…­ â†’ 36ï¼‰
                if (text.length === 2) {
                    const digit1 = chineseDigits[text[0]];
                    const digit2 = chineseDigits[text[1]];
                    if (digit1 !== undefined && digit2 !== undefined) {
                        // åªè™•ç†æœ‰æ•ˆçš„äºŒä½æ•¸çµ„åˆ
                        const result = digit1 * 10 + digit2;
                        if (result >= 10 && result <= 99) {
                            this.log(`ğŸ“ é€£çºŒæ•¸å­—è½‰æ›: "${text}" â†’ ${result}`);
                            return result;
                        }
                    }
                }

                // è™•ç†ç´”å€‹ä½æ•¸
                if (text.length === 1 && chineseDigits.hasOwnProperty(text)) {
                    return chineseDigits[text];
                }

                return null;
            }

            checkAnswer(userAnswer, transcript) {
                const expectedAnswer = this.questions[this.currentQuestion].answer;
                const correct = userAnswer === expectedAnswer;
                const responseTime = this.startTime ? (Date.now() - this.startTime) / 1000 : 0;

                this.log(`âœ… æª¢æŸ¥ç­”æ¡ˆ: ${userAnswer} vs ${expectedAnswer} = ${correct ? 'æ­£ç¢º' : 'éŒ¯èª¤'}`);

                // è¨˜éŒ„çµæœ
                this.results.push({
                    question: this.getCurrentQuestionText(),
                    expected: expectedAnswer,
                    transcript: transcript,
                    recognized: userAnswer,
                    correct: correct,
                    responseTime: responseTime
                });

                // é¡¯ç¤ºçµæœ
                document.getElementById('answer').textContent = `ä½ çš„ç­”æ¡ˆ: ${userAnswer}`;

                if (correct) {
                    document.getElementById('result').innerHTML = '<span class="result-correct">âœ… æ­£ç¢ºï¼</span>';
                } else {
                    document.getElementById('result').innerHTML = `<span class="result-incorrect">âŒ éŒ¯èª¤ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${expectedAnswer}</span>`;
                }

                this.updateStats();
                document.getElementById('next-button').style.display = 'block';
            }

            getCurrentQuestionText() {
                const q = this.questions[this.currentQuestion];
                return `${q.num1} Ã— ${q.num2}`;
            }

            loadQuestion() {
                if (this.currentQuestion < this.questions.length) {
                    const question = this.questions[this.currentQuestion];
                    document.getElementById('question').textContent = `${question.num1} Ã— ${question.num2} = ?`;
                    document.getElementById('answer').textContent = 'ç­‰å¾…èªéŸ³è¼¸å…¥...';
                    document.getElementById('result').textContent = 'é»æ“Šéº¥å…‹é¢¨èªªå‡ºç­”æ¡ˆ';
                    document.getElementById('next-button').style.display = 'none';
                    document.getElementById('transcript-area').style.display = 'none';
                } else {
                    this.showFinalResults();
                }
            }

            nextQuestion() {
                this.currentQuestion++;
                this.loadQuestion();
            }

            updateStats() {
                const correctCount = this.results.filter(r => r.correct).length;
                const successRate = this.results.length > 0 ? Math.round(correctCount / this.results.length * 100) : 0;

                document.getElementById('progress').textContent = `${this.results.length}/${this.questions.length}`;
                document.getElementById('success-rate').textContent = `${successRate}%`;
            }

            showFinalResults() {
                document.getElementById('question').textContent = 'æ¸¬è©¦å®Œæˆï¼';
                document.getElementById('answer').textContent = `ç¸½å…±å®Œæˆ ${this.results.length} é¡Œ`;
                document.getElementById('mic-button').style.display = 'none';
                document.getElementById('next-button').style.display = 'none';

                const correctCount = this.results.filter(r => r.correct).length;
                const avgTime = this.results.reduce((sum, r) => sum + r.responseTime, 0) / this.results.length;

                this.log(`ğŸŠ æ¸¬è©¦å®Œæˆï¼æ­£ç¢ºç‡: ${correctCount}/${this.results.length} (${Math.round(correctCount/this.results.length*100)}%)`);
                this.log(`â±ï¸ å¹³å‡åæ‡‰æ™‚é–“: ${avgTime.toFixed(2)}ç§’`);
            }

            showError(message) {
                const errorEl = document.getElementById('error-message');
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            }

            hideError() {
                document.getElementById('error-message').style.display = 'none';
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;
                console.log(logMessage);

                this.debugMessages.push(logMessage);
                if (this.debugMessages.length > 20) {
                    this.debugMessages.shift();
                }

                document.getElementById('debug-log').innerHTML =
                    this.debugMessages.join('<br>');
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new VoiceTestV2();
        });
    </script>
</body>
</html>