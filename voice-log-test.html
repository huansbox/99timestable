<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>èªéŸ³è­˜åˆ¥æ¸¬è©¦å·¥å…·</title>
    <meta name="description" content="çœŸå¯¦èªéŸ³è­˜åˆ¥æ¸¬è©¦ 2-81 æ•¸å­—ï¼Œè¨˜éŒ„éŒ¯èª¤æ”¹é€²ç³»çµ±">

    <!-- iOSå„ªåŒ– -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="èªéŸ³æ¸¬è©¦">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #4facfe;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .test-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .current-number {
            font-size: 8rem;
            font-weight: bold;
            color: #4facfe;
            margin: 20px 0;
            text-shadow: 0 4px 8px rgba(79, 172, 254, 0.3);
        }

        .test-status {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #666;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-mic {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            font-size: 1.5rem;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-mic.listening {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .recognition-result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .result-correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .result-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .progress-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .errors-log {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .error-item {
            background: #f8f9fa;
            border-left: 4px solid #ff6b6b;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        .error-item strong {
            color: #4facfe;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #4facfe;
            background: white;
            color: #4facfe;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #4facfe;
            color: white;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4facfe;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .current-number {
                font-size: 6rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 10px;
            }

            .test-panel, .progress-panel, .errors-log {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ èªéŸ³è­˜åˆ¥æ¸¬è©¦å·¥å…·</h1>
            <p>æ¸¬è©¦èªéŸ³è¼¸å…¥ 2-81 æ•¸å­—ï¼Œè‡ªå‹•è¨˜éŒ„è­˜åˆ¥éŒ¯èª¤ç”¨æ–¼æ”¹é€²ç³»çµ±</p>
        </div>

        <div class="main-content">
            <div class="test-panel">
                <h2>ğŸ“Š èªéŸ³æ¸¬è©¦</h2>

                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="sequential">é †åºæ¸¬è©¦</button>
                    <button class="mode-btn" data-mode="random">éš¨æ©Ÿæ¸¬è©¦</button>
                    <button class="mode-btn" data-mode="custom">è‡ªé¸æ•¸å­—</button>
                </div>

                <div class="test-status" id="test-status">æŒ‰ã€Œé–‹å§‹æ¸¬è©¦ã€é–‹å§‹</div>

                <div class="current-number" id="current-number">?</div>

                <div class="controls">
                    <button class="btn" id="start-test">ğŸš€ é–‹å§‹æ¸¬è©¦</button>
                    <button class="btn" id="stop-test" disabled>â¹ï¸ åœæ­¢æ¸¬è©¦</button>
                    <button class="btn-mic" id="mic-btn" disabled>ğŸ¤</button>
                </div>

                <div class="recognition-result" id="recognition-result">
                    è«‹èªªå‡ºä¸Šæ–¹é¡¯ç¤ºçš„æ•¸å­—
                </div>

                <div class="controls">
                    <button class="btn" id="skip-btn" disabled>â­ï¸ è·³é</button>
                    <button class="btn" id="retry-btn" disabled>ğŸ”„ é‡è©¦</button>
                    <button class="btn" id="export-btn">ğŸ“Š åŒ¯å‡ºéŒ¯èª¤è¨˜éŒ„</button>
                </div>
            </div>

            <div class="progress-panel">
                <h2>ğŸ“ˆ æ¸¬è©¦é€²åº¦</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-tested">0</div>
                        <div class="stat-label">å·²æ¸¬è©¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-correct">0</div>
                        <div class="stat-label">æ­£ç¢º</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-errors">0</div>
                        <div class="stat-label">éŒ¯èª¤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="accuracy-rate">0%</div>
                        <div class="stat-label">æº–ç¢ºç‡</div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div style="text-align: center; color: #666; margin-top: 10px;">
                    <span id="progress-text">0 / 80 (2-81)</span>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn" id="clear-logs">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
                    <button class="btn" id="view-analysis">ğŸ“Š æŸ¥çœ‹åˆ†æ</button>
                </div>
            </div>
        </div>

        <div class="errors-log">
            <h2>âš ï¸ è­˜åˆ¥éŒ¯èª¤è¨˜éŒ„ <span id="error-count">(0)</span></h2>
            <div id="errors-container">
                <div style="text-align: center; color: #666; padding: 20px;">
                    å°šç„¡éŒ¯èª¤è¨˜éŒ„
                </div>
            </div>
        </div>
    </div>

    <script>
        // VoiceLogger é¡åˆ¥ï¼ˆå¾ script.js è¤‡è£½ï¼‰
        class VoiceLogger {
            constructor() {
                this.logKey = 'voice-recognition-test-errors';
                this.maxLogs = 200;
            }

            detectDevice() {
                const ua = navigator.userAgent;
                // æª¢æ¸¬ iPhone
                if (ua.includes('iPhone')) return 'iPhone';
                // æª¢æ¸¬ iPadï¼ˆåŒ…å«æ–°ç‰ˆ iPadOSï¼‰
                if (ua.includes('iPad') ||
                    (ua.includes('Macintosh') && 'ontouchend' in document)) {
                    return 'iPad';
                }
                // å…¶ä»–è§¸æ§è£ç½®
                if ('ontouchstart' in window) return 'Touch';
                // æ¡Œé¢
                return 'Desktop';
            }

            logError(correctAnswer, recognizedText, timestamp = null) {
                const logs = this.getLogs();
                const now = timestamp || new Date();

                const logEntry = {
                    id: now.getTime(),
                    timestamp: now.toISOString(),
                    date: now.toLocaleDateString('zh-TW'),
                    time: now.toLocaleTimeString('zh-TW', { hour12: false }),
                    correctAnswer: correctAnswer.toString(),
                    recognizedText: recognizedText,
                    userAgent: this.detectDevice()
                };

                logs.push(logEntry);

                if (logs.length > this.maxLogs) {
                    logs.shift();
                }

                localStorage.setItem(this.logKey, JSON.stringify(logs));
                return logEntry;
            }

            getLogs() {
                const logs = localStorage.getItem(this.logKey);
                return logs ? JSON.parse(logs) : [];
            }

            clearLogs() {
                localStorage.removeItem(this.logKey);
            }

            exportAsCSV() {
                const logs = this.getLogs();
                if (logs.length === 0) {
                    return 'æ²’æœ‰éŒ¯èª¤è¨˜éŒ„';
                }

                const headers = ['æ—¥æœŸ', 'æ™‚é–“', 'ç›®æ¨™æ•¸å­—', 'è­˜åˆ¥çµæœ', 'è£ç½®'];
                const csvRows = [headers.join(',')];

                logs.forEach(log => {
                    const row = [
                        log.date,
                        log.time,
                        log.correctAnswer,
                        `"${log.recognizedText}"`,
                        log.userAgent
                    ];
                    csvRows.push(row.join(','));
                });

                return csvRows.join('\n');
            }

            getStats() {
                const logs = this.getLogs();
                const stats = {
                    total: logs.length,
                    byTarget: {},
                    byRecognized: {},
                    recent: logs.slice(-10)
                };

                logs.forEach(log => {
                    // æŒ‰ç›®æ¨™æ•¸å­—çµ±è¨ˆ
                    if (!stats.byTarget[log.correctAnswer]) {
                        stats.byTarget[log.correctAnswer] = [];
                    }
                    stats.byTarget[log.correctAnswer].push(log.recognizedText);

                    // æŒ‰è­˜åˆ¥çµæœçµ±è¨ˆ
                    if (!stats.byRecognized[log.recognizedText]) {
                        stats.byRecognized[log.recognizedText] = 0;
                    }
                    stats.byRecognized[log.recognizedText]++;
                });

                return stats;
            }
        }

        // èªéŸ³è­˜åˆ¥æ¸¬è©¦æ‡‰ç”¨
        class VoiceRecognitionTester {
            constructor() {
                this.logger = new VoiceLogger();
                this.recognition = null;
                this.isListening = false;
                this.currentNumber = null;
                this.testMode = 'sequential'; // sequential, random, custom
                this.testNumbers = [];
                this.currentIndex = 0;
                this.isTestRunning = false;

                // çµ±è¨ˆæ•¸æ“š
                this.totalTested = 0;
                this.totalCorrect = 0;
                this.totalErrors = 0;

                this.init();
            }

            init() {
                this.setupVoiceRecognition();
                this.setupEventListeners();
                this.updateUI();
                this.loadErrorsLog();
            }

            setupVoiceRecognition() {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    this.showToast('ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è­˜åˆ¥åŠŸèƒ½', 'error');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();

                this.recognition.lang = 'zh-TW';
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.maxAlternatives = 3;

                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.updateMicButton();
                    document.getElementById('recognition-result').textContent = 'æ­£åœ¨è½å–èªéŸ³...';
                };

                this.recognition.onresult = (event) => {
                    let finalTranscript = '';

                    for (let i = 0; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }

                    if (finalTranscript) {
                        this.processVoiceResult(finalTranscript.trim());
                    }
                };

                this.recognition.onerror = (event) => {
                    console.error('èªéŸ³è­˜åˆ¥éŒ¯èª¤:', event.error);
                    this.isListening = false;
                    this.updateMicButton();
                    document.getElementById('recognition-result').textContent = 'èªéŸ³è­˜åˆ¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦';
                };

                this.recognition.onend = () => {
                    this.isListening = false;
                    this.updateMicButton();
                };
            }

            setupEventListeners() {
                // æ¨¡å¼é¸æ“‡
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.setTestMode(btn.dataset.mode);
                    });
                });

                // æ§åˆ¶æŒ‰éˆ•
                document.getElementById('start-test').addEventListener('click', () => this.startTest());
                document.getElementById('stop-test').addEventListener('click', () => this.stopTest());
                document.getElementById('mic-btn').addEventListener('click', () => this.toggleMic());
                document.getElementById('skip-btn').addEventListener('click', () => this.skipCurrentNumber());
                document.getElementById('retry-btn').addEventListener('click', () => this.retryCurrentNumber());
                document.getElementById('export-btn').addEventListener('click', () => this.exportErrors());
                document.getElementById('clear-logs').addEventListener('click', () => this.clearLogs());
                document.getElementById('view-analysis').addEventListener('click', () => this.showAnalysis());
            }

            setTestMode(mode) {
                this.testMode = mode;

                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

                // é‡ç½®æ¸¬è©¦
                this.stopTest();
                this.generateTestNumbers();
            }

            generateTestNumbers() {
                switch (this.testMode) {
                    case 'sequential':
                        this.testNumbers = Array.from({length: 80}, (_, i) => i + 2); // 2-81
                        break;
                    case 'random':
                        this.testNumbers = Array.from({length: 80}, (_, i) => i + 2);
                        this.shuffleArray(this.testNumbers);
                        break;
                    case 'custom':
                        // ç°¡åŒ–ï¼šæ¸¬è©¦æœ€å®¹æ˜“å‡ºéŒ¯çš„æ•¸å­—
                        this.testNumbers = [8, 18, 28, 38, 48, 58, 68, 78, 4, 14, 24, 34, 44, 54, 64, 74];
                        break;
                }
                this.currentIndex = 0;
            }

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            startTest() {
                this.generateTestNumbers();
                this.isTestRunning = true;
                this.currentIndex = 0;
                this.updateControlButtons();
                this.showNextNumber();
                this.showToast('æ¸¬è©¦é–‹å§‹ï¼è«‹èªªå‡ºé¡¯ç¤ºçš„æ•¸å­—');
            }

            stopTest() {
                this.isTestRunning = false;
                this.currentNumber = null;
                this.stopListening();
                this.updateControlButtons();
                document.getElementById('current-number').textContent = '?';
                document.getElementById('test-status').textContent = 'æ¸¬è©¦å·²åœæ­¢';
                document.getElementById('recognition-result').textContent = 'æŒ‰ã€Œé–‹å§‹æ¸¬è©¦ã€é–‹å§‹';
            }

            showNextNumber() {
                if (this.currentIndex >= this.testNumbers.length) {
                    this.completeTest();
                    return;
                }

                this.currentNumber = this.testNumbers[this.currentIndex];
                document.getElementById('current-number').textContent = this.currentNumber;
                document.getElementById('test-status').textContent = `è«‹èªªå‡ºæ•¸å­—ï¼š${this.currentNumber}`;
                document.getElementById('recognition-result').textContent = 'é»æ“Šéº¥å…‹é¢¨é–‹å§‹éŒ„éŸ³';
                document.getElementById('recognition-result').className = 'recognition-result';

                this.updateProgress();
            }

            processVoiceResult(transcript) {
                const recognizedNumber = this.convertTextToNumber(transcript);

                this.totalTested++;

                if (recognizedNumber === this.currentNumber) {
                    // æ­£ç¢º
                    this.totalCorrect++;
                    document.getElementById('recognition-result').textContent = `âœ… æ­£ç¢ºï¼è­˜åˆ¥ç‚ºï¼š${transcript}`;
                    document.getElementById('recognition-result').className = 'recognition-result result-correct';

                    setTimeout(() => {
                        this.nextNumber();
                    }, 1500);
                } else {
                    // éŒ¯èª¤
                    this.totalErrors++;

                    // è¨˜éŒ„éŒ¯èª¤
                    this.logger.logError(this.currentNumber, transcript);

                    document.getElementById('recognition-result').textContent = `âŒ éŒ¯èª¤ï¼ç›®æ¨™ï¼š${this.currentNumber}ï¼Œè­˜åˆ¥ç‚ºï¼š${transcript}`;
                    document.getElementById('recognition-result').className = 'recognition-result result-error';

                    this.loadErrorsLog();

                    setTimeout(() => {
                        this.nextNumber();
                    }, 2000);
                }

                this.updateStatistics();
            }

            convertTextToNumber(text) {
                // è¤‡è£½ script.js ä¸­çš„ convertTextToNumber å‡½æ•¸
                text = text.replace(/[ï¼Œã€‚ï¼ï¼Ÿ\sé€™]/g, '');

                if (/^\d+$/.test(text)) {
                    const num = parseInt(text);
                    return num >= 0 && num <= 99 ? num : null;
                }

                const chineseDigits = {
                    'é›¶': 0, 'ã€‡': 0,
                    'ä¸€': 1, 'å£¹': 1,
                    'äºŒ': 2, 'è²³': 2, 'å…©': 2,
                    'ä¸‰': 3, 'åƒ': 3,
                    'å››': 4, 'è‚†': 4,
                    'æ˜¯': 4,
                    'äº”': 5, 'ä¼': 5,
                    'å…­': 6, 'é™¸': 6,
                    'ä¸ƒ': 7, 'æŸ’': 7,
                    'å…«': 8, 'æŒ': 8,
                    'å§': 8,
                    'ä¹': 9, 'ç–': 9
                };

                if (text === 'å') return 10;
                if (text === 'æ˜¯å§') return 48;
                if (text === 'å£«æ—') return 40;  // è™•ç†ã€Œå››åã€è¢«è­˜åˆ¥ç‚ºã€Œå£«æ—ã€çš„æƒ…æ³

                const tenMatch = text.match(/^([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?)å([é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?)$/);
                if (tenMatch) {
                    const tens = tenMatch[1] ? chineseDigits[tenMatch[1]] : 1;
                    const ones = tenMatch[2] ? chineseDigits[tenMatch[2]] : 0;
                    return tens * 10 + ones;
                }

                if (text.length === 2) {
                    const digit1 = chineseDigits[text[0]];
                    const digit2 = chineseDigits[text[1]];
                    if (digit1 !== undefined && digit2 !== undefined) {
                        const result = digit1 * 10 + digit2;
                        if (result >= 10 && result <= 99) {
                            return result;
                        }
                    }
                }

                if (text.length === 1 && chineseDigits.hasOwnProperty(text)) {
                    return chineseDigits[text];
                }

                return null;
            }

            nextNumber() {
                this.currentIndex++;
                this.showNextNumber();
            }

            skipCurrentNumber() {
                this.showToast('å·²è·³éç•¶å‰æ•¸å­—');
                this.nextNumber();
            }

            retryCurrentNumber() {
                document.getElementById('recognition-result').textContent = 'é»æ“Šéº¥å…‹é¢¨é‡æ–°éŒ„éŸ³';
                document.getElementById('recognition-result').className = 'recognition-result';
            }

            completeTest() {
                this.isTestRunning = false;
                this.updateControlButtons();

                const accuracy = this.totalTested > 0 ? ((this.totalCorrect / this.totalTested) * 100).toFixed(1) : 0;

                document.getElementById('test-status').textContent = 'æ¸¬è©¦å®Œæˆï¼';
                document.getElementById('recognition-result').textContent = `æ¸¬è©¦å®Œæˆï¼æº–ç¢ºç‡ï¼š${accuracy}%`;
                document.getElementById('recognition-result').className = 'recognition-result result-correct';

                this.showToast(`æ¸¬è©¦å®Œæˆï¼æº–ç¢ºç‡ï¼š${accuracy}%ï¼ŒéŒ¯èª¤ï¼š${this.totalErrors} å€‹`);
            }

            toggleMic() {
                if (this.isListening) {
                    this.stopListening();
                } else {
                    this.startListening();
                }
            }

            startListening() {
                if (!this.recognition || !this.currentNumber) return;

                try {
                    this.recognition.start();
                } catch (error) {
                    console.error('å•Ÿå‹•èªéŸ³è­˜åˆ¥å¤±æ•—:', error);
                }
            }

            stopListening() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
            }

            updateMicButton() {
                const micBtn = document.getElementById('mic-btn');
                if (this.isListening) {
                    micBtn.textContent = 'ğŸ”´';
                    micBtn.classList.add('listening');
                } else {
                    micBtn.textContent = 'ğŸ¤';
                    micBtn.classList.remove('listening');
                }
            }

            updateControlButtons() {
                const startBtn = document.getElementById('start-test');
                const stopBtn = document.getElementById('stop-test');
                const micBtn = document.getElementById('mic-btn');
                const skipBtn = document.getElementById('skip-btn');
                const retryBtn = document.getElementById('retry-btn');

                if (this.isTestRunning) {
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    micBtn.disabled = false;
                    skipBtn.disabled = false;
                    retryBtn.disabled = false;
                } else {
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    micBtn.disabled = true;
                    skipBtn.disabled = true;
                    retryBtn.disabled = true;
                }
            }

            updateProgress() {
                const total = this.testNumbers.length;
                const current = this.currentIndex + 1;
                const percentage = (current / total) * 100;

                document.getElementById('progress-fill').style.width = `${percentage}%`;
                document.getElementById('progress-text').textContent = `${current} / ${total}`;
            }

            updateStatistics() {
                document.getElementById('total-tested').textContent = this.totalTested;
                document.getElementById('total-correct').textContent = this.totalCorrect;
                document.getElementById('total-errors').textContent = this.totalErrors;

                const accuracy = this.totalTested > 0 ? ((this.totalCorrect / this.totalTested) * 100).toFixed(1) : 0;
                document.getElementById('accuracy-rate').textContent = `${accuracy}%`;
            }

            updateUI() {
                this.updateControlButtons();
                this.updateStatistics();
            }

            loadErrorsLog() {
                const logs = this.logger.getLogs();
                const container = document.getElementById('errors-container');

                document.getElementById('error-count').textContent = `(${logs.length})`;

                if (logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">å°šç„¡éŒ¯èª¤è¨˜éŒ„</div>';
                    return;
                }

                const recentLogs = logs.slice(-10).reverse(); // æœ€è¿‘10ç­†ï¼Œæœ€æ–°çš„åœ¨å‰

                container.innerHTML = recentLogs.map(log => `
                    <div class="error-item">
                        <strong>ç›®æ¨™ï¼š${log.correctAnswer}</strong> â†’ è­˜åˆ¥ç‚ºï¼š<span style="color: #ff6b6b;">${log.recognizedText}</span>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            ${log.date} ${log.time} | ${log.userAgent}
                        </div>
                    </div>
                `).join('');
            }

            exportErrors() {
                const csvContent = this.logger.exportAsCSV();

                if (csvContent === 'æ²’æœ‰éŒ¯èª¤è¨˜éŒ„') {
                    this.showToast('æ²’æœ‰éŒ¯èª¤è¨˜éŒ„å¯ä»¥åŒ¯å‡º', 'error');
                    return;
                }

                navigator.clipboard.writeText(csvContent).then(() => {
                    this.showToast('CSV éŒ¯èª¤è¨˜éŒ„å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                }).catch(() => {
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `voice-recognition-test-errors-${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    this.showToast('CSV æª”æ¡ˆå·²ä¸‹è¼‰');
                });
            }

            clearLogs() {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰éŒ¯èª¤è¨˜éŒ„å—ï¼Ÿ')) {
                    this.logger.clearLogs();
                    this.loadErrorsLog();
                    this.showToast('éŒ¯èª¤è¨˜éŒ„å·²æ¸…é™¤');
                }
            }

            showAnalysis() {
                const stats = this.logger.getStats();
                if (stats.total === 0) {
                    this.showToast('æ²’æœ‰éŒ¯èª¤è¨˜éŒ„å¯ä»¥åˆ†æ', 'error');
                    return;
                }

                const topErrors = Object.entries(stats.byTarget)
                    .sort(([,a], [,b]) => b.length - a.length)
                    .slice(0, 5);

                const topMisrecognitions = Object.entries(stats.byRecognized)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);

                let analysis = `=== èªéŸ³è­˜åˆ¥éŒ¯èª¤åˆ†æ ===\n\n`;
                analysis += `ç¸½éŒ¯èª¤æ•¸ï¼š${stats.total}\n\n`;

                analysis += `æœ€å®¹æ˜“å‡ºéŒ¯çš„æ•¸å­—ï¼š\n`;
                topErrors.forEach(([num, errors]) => {
                    analysis += `- ${num}ï¼š${errors.length} æ¬¡éŒ¯èª¤\n`;
                });

                analysis += `\næœ€å¸¸è¦‹çš„èª¤è­˜åˆ¥ï¼š\n`;
                topMisrecognitions.forEach(([text, count]) => {
                    analysis += `- ã€Œ${text}ã€ï¼š${count} æ¬¡\n`;
                });

                navigator.clipboard.writeText(analysis).then(() => {
                    this.showToast('åˆ†æå ±å‘Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                });
            }

            showToast(message, type = 'success') {
                const existingToast = document.querySelector('.toast');
                if (existingToast) {
                    existingToast.remove();
                }

                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;

                if (type === 'error') {
                    toast.style.background = '#ff6b6b';
                }

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new VoiceRecognitionTester();
        });
    </script>
</body>
</html>