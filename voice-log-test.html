<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>語音識別測試工具</title>
    <meta name="description" content="真實語音識別測試 2-81 數字，記錄錯誤改進系統">

    <!-- iOS優化 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="語音測試">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #4facfe;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .test-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .current-number {
            font-size: 8rem;
            font-weight: bold;
            color: #4facfe;
            margin: 20px 0;
            text-shadow: 0 4px 8px rgba(79, 172, 254, 0.3);
        }

        .test-status {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #666;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-mic {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            font-size: 1.5rem;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-mic.listening {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .recognition-result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .result-correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .result-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .progress-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .errors-log {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .error-item {
            background: #f8f9fa;
            border-left: 4px solid #ff6b6b;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        .error-item strong {
            color: #4facfe;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #4facfe;
            background: white;
            color: #4facfe;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #4facfe;
            color: white;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4facfe;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .current-number {
                font-size: 6rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 10px;
            }

            .test-panel, .progress-panel, .errors-log {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎤 語音識別測試工具</h1>
            <p>測試語音輸入 2-81 數字，自動記錄識別錯誤用於改進系統</p>
        </div>

        <div class="main-content">
            <div class="test-panel">
                <h2>📊 語音測試</h2>

                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="sequential">順序測試</button>
                    <button class="mode-btn" data-mode="random">隨機測試</button>
                    <button class="mode-btn" data-mode="custom">自選數字</button>
                </div>

                <div class="test-status" id="test-status">按「開始測試」開始</div>

                <div class="current-number" id="current-number">?</div>

                <div class="controls">
                    <button class="btn" id="start-test">🚀 開始測試</button>
                    <button class="btn" id="stop-test" disabled>⏹️ 停止測試</button>
                    <button class="btn-mic" id="mic-btn" disabled>🎤</button>
                </div>

                <div class="recognition-result" id="recognition-result">
                    請說出上方顯示的數字
                </div>

                <div class="controls">
                    <button class="btn" id="skip-btn" disabled>⏭️ 跳過</button>
                    <button class="btn" id="retry-btn" disabled>🔄 重試</button>
                    <button class="btn" id="export-btn">📊 匯出錯誤記錄</button>
                </div>
            </div>

            <div class="progress-panel">
                <h2>📈 測試進度</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-tested">0</div>
                        <div class="stat-label">已測試</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-correct">0</div>
                        <div class="stat-label">正確</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-errors">0</div>
                        <div class="stat-label">錯誤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="accuracy-rate">0%</div>
                        <div class="stat-label">準確率</div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div style="text-align: center; color: #666; margin-top: 10px;">
                    <span id="progress-text">0 / 80 (2-81)</span>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn" id="clear-logs">🗑️ 清除記錄</button>
                    <button class="btn" id="view-analysis">📊 查看分析</button>
                </div>
            </div>
        </div>

        <div class="errors-log">
            <h2>⚠️ 識別錯誤記錄 <span id="error-count">(0)</span></h2>
            <div id="errors-container">
                <div style="text-align: center; color: #666; padding: 20px;">
                    尚無錯誤記錄
                </div>
            </div>
        </div>
    </div>

    <script>
        // VoiceLogger 類別（從 script.js 複製）
        class VoiceLogger {
            constructor() {
                this.logKey = 'voice-recognition-test-errors';
                this.maxLogs = 200;
            }

            detectDevice() {
                const ua = navigator.userAgent;
                // 檢測 iPhone
                if (ua.includes('iPhone')) return 'iPhone';
                // 檢測 iPad（包含新版 iPadOS）
                if (ua.includes('iPad') ||
                    (ua.includes('Macintosh') && 'ontouchend' in document)) {
                    return 'iPad';
                }
                // 其他觸控裝置
                if ('ontouchstart' in window) return 'Touch';
                // 桌面
                return 'Desktop';
            }

            logError(correctAnswer, recognizedText, timestamp = null) {
                const logs = this.getLogs();
                const now = timestamp || new Date();

                const logEntry = {
                    id: now.getTime(),
                    timestamp: now.toISOString(),
                    date: now.toLocaleDateString('zh-TW'),
                    time: now.toLocaleTimeString('zh-TW', { hour12: false }),
                    correctAnswer: correctAnswer.toString(),
                    recognizedText: recognizedText,
                    userAgent: this.detectDevice()
                };

                logs.push(logEntry);

                if (logs.length > this.maxLogs) {
                    logs.shift();
                }

                localStorage.setItem(this.logKey, JSON.stringify(logs));
                return logEntry;
            }

            getLogs() {
                const logs = localStorage.getItem(this.logKey);
                return logs ? JSON.parse(logs) : [];
            }

            clearLogs() {
                localStorage.removeItem(this.logKey);
            }

            exportAsCSV() {
                const logs = this.getLogs();
                if (logs.length === 0) {
                    return '沒有錯誤記錄';
                }

                const headers = ['日期', '時間', '目標數字', '識別結果', '裝置'];
                const csvRows = [headers.join(',')];

                logs.forEach(log => {
                    const row = [
                        log.date,
                        log.time,
                        log.correctAnswer,
                        `"${log.recognizedText}"`,
                        log.userAgent
                    ];
                    csvRows.push(row.join(','));
                });

                return csvRows.join('\n');
            }

            getStats() {
                const logs = this.getLogs();
                const stats = {
                    total: logs.length,
                    byTarget: {},
                    byRecognized: {},
                    recent: logs.slice(-10)
                };

                logs.forEach(log => {
                    // 按目標數字統計
                    if (!stats.byTarget[log.correctAnswer]) {
                        stats.byTarget[log.correctAnswer] = [];
                    }
                    stats.byTarget[log.correctAnswer].push(log.recognizedText);

                    // 按識別結果統計
                    if (!stats.byRecognized[log.recognizedText]) {
                        stats.byRecognized[log.recognizedText] = 0;
                    }
                    stats.byRecognized[log.recognizedText]++;
                });

                return stats;
            }
        }

        // 語音識別測試應用
        class VoiceRecognitionTester {
            constructor() {
                this.logger = new VoiceLogger();
                this.recognition = null;
                this.isListening = false;
                this.currentNumber = null;
                this.testMode = 'sequential'; // sequential, random, custom
                this.testNumbers = [];
                this.currentIndex = 0;
                this.isTestRunning = false;

                // 統計數據
                this.totalTested = 0;
                this.totalCorrect = 0;
                this.totalErrors = 0;

                this.init();
            }

            init() {
                this.setupVoiceRecognition();
                this.setupEventListeners();
                this.updateUI();
                this.loadErrorsLog();
            }

            setupVoiceRecognition() {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    this.showToast('瀏覽器不支援語音識別功能', 'error');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();

                this.recognition.lang = 'zh-TW';
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.maxAlternatives = 3;

                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.updateMicButton();
                    document.getElementById('recognition-result').textContent = '正在聽取語音...';
                };

                this.recognition.onresult = (event) => {
                    let finalTranscript = '';

                    for (let i = 0; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }

                    if (finalTranscript) {
                        this.processVoiceResult(finalTranscript.trim());
                    }
                };

                this.recognition.onerror = (event) => {
                    console.error('語音識別錯誤:', event.error);
                    this.isListening = false;
                    this.updateMicButton();
                    document.getElementById('recognition-result').textContent = '語音識別發生錯誤，請重試';
                };

                this.recognition.onend = () => {
                    this.isListening = false;
                    this.updateMicButton();
                };
            }

            setupEventListeners() {
                // 模式選擇
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.setTestMode(btn.dataset.mode);
                    });
                });

                // 控制按鈕
                document.getElementById('start-test').addEventListener('click', () => this.startTest());
                document.getElementById('stop-test').addEventListener('click', () => this.stopTest());
                document.getElementById('mic-btn').addEventListener('click', () => this.toggleMic());
                document.getElementById('skip-btn').addEventListener('click', () => this.skipCurrentNumber());
                document.getElementById('retry-btn').addEventListener('click', () => this.retryCurrentNumber());
                document.getElementById('export-btn').addEventListener('click', () => this.exportErrors());
                document.getElementById('clear-logs').addEventListener('click', () => this.clearLogs());
                document.getElementById('view-analysis').addEventListener('click', () => this.showAnalysis());
            }

            setTestMode(mode) {
                this.testMode = mode;

                // 更新按鈕狀態
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

                // 重置測試
                this.stopTest();
                this.generateTestNumbers();
            }

            generateTestNumbers() {
                switch (this.testMode) {
                    case 'sequential':
                        this.testNumbers = Array.from({length: 80}, (_, i) => i + 2); // 2-81
                        break;
                    case 'random':
                        this.testNumbers = Array.from({length: 80}, (_, i) => i + 2);
                        this.shuffleArray(this.testNumbers);
                        break;
                    case 'custom':
                        // 簡化：測試最容易出錯的數字
                        this.testNumbers = [8, 18, 28, 38, 48, 58, 68, 78, 4, 14, 24, 34, 44, 54, 64, 74];
                        break;
                }
                this.currentIndex = 0;
            }

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            startTest() {
                this.generateTestNumbers();
                this.isTestRunning = true;
                this.currentIndex = 0;
                this.updateControlButtons();
                this.showNextNumber();
                this.showToast('測試開始！請說出顯示的數字');
            }

            stopTest() {
                this.isTestRunning = false;
                this.currentNumber = null;
                this.stopListening();
                this.updateControlButtons();
                document.getElementById('current-number').textContent = '?';
                document.getElementById('test-status').textContent = '測試已停止';
                document.getElementById('recognition-result').textContent = '按「開始測試」開始';
            }

            showNextNumber() {
                if (this.currentIndex >= this.testNumbers.length) {
                    this.completeTest();
                    return;
                }

                this.currentNumber = this.testNumbers[this.currentIndex];
                document.getElementById('current-number').textContent = this.currentNumber;
                document.getElementById('test-status').textContent = `請說出數字：${this.currentNumber}`;
                document.getElementById('recognition-result').textContent = '點擊麥克風開始錄音';
                document.getElementById('recognition-result').className = 'recognition-result';

                this.updateProgress();
            }

            processVoiceResult(transcript) {
                const recognizedNumber = this.convertTextToNumber(transcript);

                this.totalTested++;

                if (recognizedNumber === this.currentNumber) {
                    // 正確
                    this.totalCorrect++;
                    document.getElementById('recognition-result').textContent = `✅ 正確！識別為：${transcript}`;
                    document.getElementById('recognition-result').className = 'recognition-result result-correct';

                    setTimeout(() => {
                        this.nextNumber();
                    }, 1500);
                } else {
                    // 錯誤
                    this.totalErrors++;

                    // 記錄錯誤
                    this.logger.logError(this.currentNumber, transcript);

                    document.getElementById('recognition-result').textContent = `❌ 錯誤！目標：${this.currentNumber}，識別為：${transcript}`;
                    document.getElementById('recognition-result').className = 'recognition-result result-error';

                    this.loadErrorsLog();

                    setTimeout(() => {
                        this.nextNumber();
                    }, 2000);
                }

                this.updateStatistics();
            }

            convertTextToNumber(text) {
                // 複製 script.js 中的 convertTextToNumber 函數
                text = text.replace(/[，。！？\s這]/g, '');

                if (/^\d+$/.test(text)) {
                    const num = parseInt(text);
                    return num >= 0 && num <= 99 ? num : null;
                }

                const chineseDigits = {
                    '零': 0, '〇': 0,
                    '一': 1, '壹': 1,
                    '二': 2, '貳': 2, '兩': 2,
                    '三': 3, '參': 3,
                    '四': 4, '肆': 4,
                    '是': 4,
                    '五': 5, '伍': 5,
                    '六': 6, '陸': 6,
                    '七': 7, '柒': 7,
                    '八': 8, '捌': 8,
                    '吧': 8,
                    '九': 9, '玖': 9
                };

                if (text === '十') return 10;
                if (text === '是吧') return 48;
                if (text === '士林') return 40;  // 處理「四十」被識別為「士林」的情況

                const tenMatch = text.match(/^([一二三四五六七八九]?)十([零一二三四五六七八九]?)$/);
                if (tenMatch) {
                    const tens = tenMatch[1] ? chineseDigits[tenMatch[1]] : 1;
                    const ones = tenMatch[2] ? chineseDigits[tenMatch[2]] : 0;
                    return tens * 10 + ones;
                }

                if (text.length === 2) {
                    const digit1 = chineseDigits[text[0]];
                    const digit2 = chineseDigits[text[1]];
                    if (digit1 !== undefined && digit2 !== undefined) {
                        const result = digit1 * 10 + digit2;
                        if (result >= 10 && result <= 99) {
                            return result;
                        }
                    }
                }

                if (text.length === 1 && chineseDigits.hasOwnProperty(text)) {
                    return chineseDigits[text];
                }

                return null;
            }

            nextNumber() {
                this.currentIndex++;
                this.showNextNumber();
            }

            skipCurrentNumber() {
                this.showToast('已跳過當前數字');
                this.nextNumber();
            }

            retryCurrentNumber() {
                document.getElementById('recognition-result').textContent = '點擊麥克風重新錄音';
                document.getElementById('recognition-result').className = 'recognition-result';
            }

            completeTest() {
                this.isTestRunning = false;
                this.updateControlButtons();

                const accuracy = this.totalTested > 0 ? ((this.totalCorrect / this.totalTested) * 100).toFixed(1) : 0;

                document.getElementById('test-status').textContent = '測試完成！';
                document.getElementById('recognition-result').textContent = `測試完成！準確率：${accuracy}%`;
                document.getElementById('recognition-result').className = 'recognition-result result-correct';

                this.showToast(`測試完成！準確率：${accuracy}%，錯誤：${this.totalErrors} 個`);
            }

            toggleMic() {
                if (this.isListening) {
                    this.stopListening();
                } else {
                    this.startListening();
                }
            }

            startListening() {
                if (!this.recognition || !this.currentNumber) return;

                try {
                    this.recognition.start();
                } catch (error) {
                    console.error('啟動語音識別失敗:', error);
                }
            }

            stopListening() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
            }

            updateMicButton() {
                const micBtn = document.getElementById('mic-btn');
                if (this.isListening) {
                    micBtn.textContent = '🔴';
                    micBtn.classList.add('listening');
                } else {
                    micBtn.textContent = '🎤';
                    micBtn.classList.remove('listening');
                }
            }

            updateControlButtons() {
                const startBtn = document.getElementById('start-test');
                const stopBtn = document.getElementById('stop-test');
                const micBtn = document.getElementById('mic-btn');
                const skipBtn = document.getElementById('skip-btn');
                const retryBtn = document.getElementById('retry-btn');

                if (this.isTestRunning) {
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    micBtn.disabled = false;
                    skipBtn.disabled = false;
                    retryBtn.disabled = false;
                } else {
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    micBtn.disabled = true;
                    skipBtn.disabled = true;
                    retryBtn.disabled = true;
                }
            }

            updateProgress() {
                const total = this.testNumbers.length;
                const current = this.currentIndex + 1;
                const percentage = (current / total) * 100;

                document.getElementById('progress-fill').style.width = `${percentage}%`;
                document.getElementById('progress-text').textContent = `${current} / ${total}`;
            }

            updateStatistics() {
                document.getElementById('total-tested').textContent = this.totalTested;
                document.getElementById('total-correct').textContent = this.totalCorrect;
                document.getElementById('total-errors').textContent = this.totalErrors;

                const accuracy = this.totalTested > 0 ? ((this.totalCorrect / this.totalTested) * 100).toFixed(1) : 0;
                document.getElementById('accuracy-rate').textContent = `${accuracy}%`;
            }

            updateUI() {
                this.updateControlButtons();
                this.updateStatistics();
            }

            loadErrorsLog() {
                const logs = this.logger.getLogs();
                const container = document.getElementById('errors-container');

                document.getElementById('error-count').textContent = `(${logs.length})`;

                if (logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">尚無錯誤記錄</div>';
                    return;
                }

                const recentLogs = logs.slice(-10).reverse(); // 最近10筆，最新的在前

                container.innerHTML = recentLogs.map(log => `
                    <div class="error-item">
                        <strong>目標：${log.correctAnswer}</strong> → 識別為：<span style="color: #ff6b6b;">${log.recognizedText}</span>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            ${log.date} ${log.time} | ${log.userAgent}
                        </div>
                    </div>
                `).join('');
            }

            exportErrors() {
                const csvContent = this.logger.exportAsCSV();

                if (csvContent === '沒有錯誤記錄') {
                    this.showToast('沒有錯誤記錄可以匯出', 'error');
                    return;
                }

                navigator.clipboard.writeText(csvContent).then(() => {
                    this.showToast('CSV 錯誤記錄已複製到剪貼簿');
                }).catch(() => {
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `voice-recognition-test-errors-${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    this.showToast('CSV 檔案已下載');
                });
            }

            clearLogs() {
                if (confirm('確定要清除所有錯誤記錄嗎？')) {
                    this.logger.clearLogs();
                    this.loadErrorsLog();
                    this.showToast('錯誤記錄已清除');
                }
            }

            showAnalysis() {
                const stats = this.logger.getStats();
                if (stats.total === 0) {
                    this.showToast('沒有錯誤記錄可以分析', 'error');
                    return;
                }

                const topErrors = Object.entries(stats.byTarget)
                    .sort(([,a], [,b]) => b.length - a.length)
                    .slice(0, 5);

                const topMisrecognitions = Object.entries(stats.byRecognized)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);

                let analysis = `=== 語音識別錯誤分析 ===\n\n`;
                analysis += `總錯誤數：${stats.total}\n\n`;

                analysis += `最容易出錯的數字：\n`;
                topErrors.forEach(([num, errors]) => {
                    analysis += `- ${num}：${errors.length} 次錯誤\n`;
                });

                analysis += `\n最常見的誤識別：\n`;
                topMisrecognitions.forEach(([text, count]) => {
                    analysis += `- 「${text}」：${count} 次\n`;
                });

                navigator.clipboard.writeText(analysis).then(() => {
                    this.showToast('分析報告已複製到剪貼簿');
                });
            }

            showToast(message, type = 'success') {
                const existingToast = document.querySelector('.toast');
                if (existingToast) {
                    existingToast.remove();
                }

                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;

                if (type === 'error') {
                    toast.style.background = '#ff6b6b';
                }

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // 初始化應用
        document.addEventListener('DOMContentLoaded', () => {
            new VoiceRecognitionTester();
        });
    </script>
</body>
</html>