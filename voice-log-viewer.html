<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>語音識別錯誤日誌測試</title>
    <meta name="description" content="語音識別錯誤日誌功能測試頁面">

    <!-- iOS優化 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="語音日誌測試">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            background: #fafafa;
        }

        .section h2 {
            color: #4facfe;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .log-table th {
            background: #4facfe;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .log-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .log-table tr:hover {
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stats-card h3 {
            color: #4facfe;
            margin-bottom: 15px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .stats-item:last-child {
            border-bottom: none;
        }

        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 30px;
        }

        .auto-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4facfe;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .log-count {
            background: #4facfe;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .content {
                padding: 20px;
            }

            .section {
                padding: 20px;
            }

            .auto-test-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .log-table {
                font-size: 14px;
            }

            .log-table th,
            .log-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎤 語音識別錯誤日誌測試</h1>
            <p>測試語音識別錯誤記錄系統功能</p>
        </div>

        <div class="content">
            <!-- 手動模擬區域 -->
            <div class="section">
                <h2>📝 手動模擬錯誤</h2>
                <div class="form-group">
                    <label for="correct-answer">正確答案：</label>
                    <input type="number" id="correct-answer" placeholder="例如：8" min="1" max="99">
                </div>
                <div class="form-group">
                    <label for="recognized-text">識別結果：</label>
                    <input type="text" id="recognized-text" placeholder="例如：吧、是吧、七、九">
                </div>
                <div class="form-group">
                    <label for="question-text">題目：</label>
                    <input type="text" id="question-text" placeholder="例如：2 × 4 = (?)">
                </div>
                <button class="btn" onclick="addManualLog()">➕ 新增錯誤記錄</button>
            </div>

            <!-- 自動測試區域 -->
            <div class="section">
                <h2>🚀 自動測試案例</h2>
                <p style="margin-bottom: 20px; color: #666;">點擊下方按鈕快速生成不同類型的測試數據：</p>
                <div class="auto-test-grid">
                    <button class="btn" onclick="addTestCase('八', '吧', '2 × 4 = (?)')">「八」→「吧」</button>
                    <button class="btn" onclick="addTestCase('四八', '是吧', '6 × 8 = (?)')">「四八」→「是吧」</button>
                    <button class="btn" onclick="addTestCase('四', '是', '3 × (?) = 12')">「四」→「是」</button>
                    <button class="btn" onclick="addTestCase('七', '奇', '7 × 3 = (?)')">「七」→「奇」</button>
                    <button class="btn" onclick="addTestCase('九', '鳩', '9 × 6 = (?)')">「九」→「鳩」</button>
                    <button class="btn" onclick="addTestCase('六', '流', '2 × 3 = (?)')">「六」→「流」</button>
                    <button class="btn" onclick="addTestCase('二十四', '24', '8 × 3 = (?)')">數字混合</button>
                    <button class="btn" onclick="generateRandomTests()">🎲 生成隨機測試</button>
                </div>
            </div>

            <!-- 日誌管理區域 -->
            <div class="section">
                <h2>🗂️ 日誌管理 <span class="log-count" id="log-count">0 筆記錄</span></h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="refreshLogs()">🔄 重新載入</button>
                    <button class="btn btn-secondary" onclick="exportCSV()">📊 匯出 CSV</button>
                    <button class="btn btn-danger" onclick="clearAllLogs()">🗑️ 清除所有日誌</button>
                </div>

                <div id="logs-container">
                    <div class="no-data">尚無日誌記錄</div>
                </div>
            </div>

            <!-- 統計資訊區域 -->
            <div class="section">
                <h2>📈 統計資訊</h2>
                <div id="stats-container" class="stats-grid">
                    <div class="no-data">載入統計資訊中...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // VoiceLogger 類別
        class VoiceLogger {
            constructor() {
                this.logKey = 'voice-recognition-errors';
                this.maxLogs = 100; // 最多保存 100 筆記錄
            }

            // 記錄語音識別錯誤
            logError(correctAnswer, recognizedText, question) {
                const logs = this.getLogs();
                const timestamp = new Date();

                const logEntry = {
                    id: timestamp.getTime(),
                    timestamp: timestamp.toISOString(),
                    date: timestamp.toLocaleDateString('zh-TW'),
                    time: timestamp.toLocaleTimeString('zh-TW', { hour12: false }),
                    correctAnswer: correctAnswer,
                    recognizedText: recognizedText,
                    question: question,
                    userAgent: navigator.userAgent.includes('iPad') ? 'iPad' :
                              navigator.userAgent.includes('iPhone') ? 'iPhone' : 'Desktop'
                };

                logs.push(logEntry);

                // 限制日誌數量，移除最舊的記錄
                if (logs.length > this.maxLogs) {
                    logs.shift();
                }

                localStorage.setItem(this.logKey, JSON.stringify(logs));
                console.log('語音錯誤已記錄:', logEntry);
                return logEntry;
            }

            // 取得所有日誌
            getLogs() {
                const logs = localStorage.getItem(this.logKey);
                return logs ? JSON.parse(logs) : [];
            }

            // 取得日誌總數
            getLogCount() {
                return this.getLogs().length;
            }

            // 清除所有日誌
            clearLogs() {
                localStorage.removeItem(this.logKey);
            }

            // 匯出為 CSV 格式
            exportAsCSV() {
                const logs = this.getLogs();
                if (logs.length === 0) {
                    return '沒有日誌資料';
                }

                const headers = ['日期', '時間', '正確答案', '識別結果', '題目', '裝置'];
                const csvRows = [headers.join(',')];

                logs.forEach(log => {
                    const row = [
                        log.date,
                        log.time,
                        log.correctAnswer,
                        `"${log.recognizedText}"`, // 用引號包圍避免 CSV 問題
                        `"${log.question}"`,
                        log.userAgent
                    ];
                    csvRows.push(row.join(','));
                });

                return csvRows.join('\n');
            }

            // 取得統計資料
            getStats() {
                const logs = this.getLogs();
                const stats = {
                    total: logs.length,
                    byAnswer: {},
                    byRecognized: {},
                    recent: logs.slice(-10) // 最近 10 筆
                };

                logs.forEach(log => {
                    // 按正確答案統計
                    if (!stats.byAnswer[log.correctAnswer]) {
                        stats.byAnswer[log.correctAnswer] = [];
                    }
                    stats.byAnswer[log.correctAnswer].push(log.recognizedText);

                    // 按識別文字統計
                    if (!stats.byRecognized[log.recognizedText]) {
                        stats.byRecognized[log.recognizedText] = 0;
                    }
                    stats.byRecognized[log.recognizedText]++;
                });

                return stats;
            }
        }

        // 初始化日誌系統
        const voiceLogger = new VoiceLogger();

        // 頁面載入時刷新顯示
        document.addEventListener('DOMContentLoaded', function() {
            refreshLogs();
            updateStats();
            updateLogCount();
        });

        // 手動新增日誌記錄
        function addManualLog() {
            const correctAnswer = document.getElementById('correct-answer').value;
            const recognizedText = document.getElementById('recognized-text').value;
            const questionText = document.getElementById('question-text').value;

            if (!correctAnswer || !recognizedText || !questionText) {
                showToast('請填寫所有欄位', 'error');
                return;
            }

            const logEntry = voiceLogger.logError(parseInt(correctAnswer), recognizedText, questionText);

            // 清空表單
            document.getElementById('correct-answer').value = '';
            document.getElementById('recognized-text').value = '';
            document.getElementById('question-text').value = '';

            showToast('✅ 已新增錯誤記錄');
            refreshLogs();
            updateStats();
            updateLogCount();
        }

        // 新增測試案例
        function addTestCase(correctAnswer, recognizedText, questionText) {
            const logEntry = voiceLogger.logError(correctAnswer, recognizedText, questionText);
            showToast(`✅ 已新增測試案例: ${recognizedText}`);
            refreshLogs();
            updateStats();
            updateLogCount();
        }

        // 生成隨機測試數據
        function generateRandomTests() {
            const testCases = [
                {correct: '8', recognized: '吧', question: '2 × 4 = (?)'},
                {correct: '48', recognized: '是吧', question: '6 × 8 = (?)'},
                {correct: '4', recognized: '是', question: '2 × 2 = (?)'},
                {correct: '7', recognized: '奇', question: '7 × 1 = (?)'},
                {correct: '9', recognized: '鳩', question: '3 × 3 = (?)'},
                {correct: '6', recognized: '流', question: '2 × 3 = (?)'},
                {correct: '12', recognized: '十二', question: '4 × 3 = (?)'},
                {correct: '15', recognized: '五十', question: '3 × 5 = (?)'},
                {correct: '21', recognized: '二一', question: '7 × 3 = (?)'},
                {correct: '36', recognized: '三流', question: '6 × 6 = (?)'}
            ];

            // 隨機選擇 3-5 個測試案例
            const count = Math.floor(Math.random() * 3) + 3;
            const selectedCases = testCases.sort(() => 0.5 - Math.random()).slice(0, count);

            selectedCases.forEach((testCase, index) => {
                setTimeout(() => {
                    voiceLogger.logError(testCase.correct, testCase.recognized, testCase.question);
                }, index * 100); // 間隔 100ms 添加
            });

            setTimeout(() => {
                showToast(`🎲 已生成 ${count} 筆隨機測試數據`);
                refreshLogs();
                updateStats();
                updateLogCount();
            }, count * 100 + 100);
        }

        // 刷新日誌顯示
        function refreshLogs() {
            const logs = voiceLogger.getLogs();
            const container = document.getElementById('logs-container');

            if (logs.length === 0) {
                container.innerHTML = '<div class="no-data">尚無日誌記錄</div>';
                return;
            }

            // 按時間倒序排列（最新的在前）
            const sortedLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const tableHTML = `
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>日期時間</th>
                            <th>正確答案</th>
                            <th>識別結果</th>
                            <th>題目</th>
                            <th>裝置</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedLogs.map(log => `
                            <tr>
                                <td>${log.date} ${log.time}</td>
                                <td style="font-weight: bold; color: #4facfe;">${log.correctAnswer}</td>
                                <td style="color: #ff6b6b;">${log.recognizedText}</td>
                                <td>${log.question}</td>
                                <td>${log.userAgent}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // 更新統計資訊
        function updateStats() {
            const stats = voiceLogger.getStats();
            const container = document.getElementById('stats-container');

            if (stats.total === 0) {
                container.innerHTML = '<div class="no-data">尚無統計資料</div>';
                return;
            }

            // 處理統計數據
            const topMisrecognitions = Object.entries(stats.byRecognized)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            const topProblematicAnswers = Object.entries(stats.byAnswer)
                .sort(([,a], [,b]) => b.length - a.length)
                .slice(0, 10);

            const statsHTML = `
                <div class="stats-card">
                    <h3>📊 總體統計</h3>
                    <div class="stats-item">
                        <span>總記錄數：</span>
                        <strong>${stats.total} 筆</strong>
                    </div>
                    <div class="stats-item">
                        <span>不同答案數：</span>
                        <strong>${Object.keys(stats.byAnswer).length} 個</strong>
                    </div>
                    <div class="stats-item">
                        <span>不同誤識別：</span>
                        <strong>${Object.keys(stats.byRecognized).length} 種</strong>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>🎯 常見誤識別</h3>
                    ${topMisrecognitions.length > 0 ?
                        topMisrecognitions.map(([text, count]) => `
                            <div class="stats-item">
                                <span>「${text}」</span>
                                <strong>${count} 次</strong>
                            </div>
                        `).join('') :
                        '<div class="no-data">暫無資料</div>'
                    }
                </div>

                <div class="stats-card">
                    <h3>⚠️ 問題答案</h3>
                    ${topProblematicAnswers.length > 0 ?
                        topProblematicAnswers.map(([answer, errors]) => `
                            <div class="stats-item">
                                <span>答案「${answer}」</span>
                                <strong>${errors.length} 次錯誤</strong>
                            </div>
                        `).join('') :
                        '<div class="no-data">暫無資料</div>'
                    }
                </div>

                <div class="stats-card">
                    <h3>🕒 最近記錄</h3>
                    ${stats.recent.length > 0 ?
                        stats.recent.slice(0, 5).map(log => `
                            <div class="stats-item">
                                <span>${log.correctAnswer} → ${log.recognizedText}</span>
                                <small>${log.time}</small>
                            </div>
                        `).join('') :
                        '<div class="no-data">暫無資料</div>'
                    }
                </div>
            `;

            container.innerHTML = statsHTML;
        }

        // 更新日誌計數
        function updateLogCount() {
            const count = voiceLogger.getLogCount();
            document.getElementById('log-count').textContent = `${count} 筆記錄`;
        }

        // 匯出 CSV
        function exportCSV() {
            const csvContent = voiceLogger.exportAsCSV();

            if (csvContent === '沒有日誌資料') {
                showToast('❌ 沒有日誌資料可以匯出', 'error');
                return;
            }

            // 複製到剪貼簿
            navigator.clipboard.writeText(csvContent).then(() => {
                showToast('📋 CSV 資料已複製到剪貼簿，可以貼到 Excel 或 Google Sheets');
            }).catch(() => {
                // 如果複製失敗，創建下載連結
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `voice-recognition-errors-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('📥 CSV 檔案已下載');
            });
        }

        // 清除所有日誌
        function clearAllLogs() {
            if (confirm('⚠️ 確定要清除所有日誌記錄嗎？此操作無法復原。')) {
                voiceLogger.clearLogs();
                showToast('🗑️ 所有日誌記錄已清除');
                refreshLogs();
                updateStats();
                updateLogCount();
            }
        }

        // 顯示提示訊息
        function showToast(message, type = 'success') {
            // 移除現有的 toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;

            if (type === 'error') {
                toast.style.background = '#ff6b6b';
            }

            document.body.appendChild(toast);

            // 觸發動畫
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // 3秒後移除
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>